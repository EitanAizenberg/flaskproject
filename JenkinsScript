pipeline {
    agent any
    triggers {
        pollSCM('*/1 * * * *') // Makes it build every minute
    }

    stages {
        stage('Cleanup') {
            steps {
                echo 'Cleaning up!'
                cleanWs() // Cleans up the last run of the script because it cannot clone a git repository twice
            }
        }

        stage('Clone Repository') {
            steps {
                echo 'Cloning repository'
                GIT_TRACE=true
                git clone 'https://github.com/EitanAizenberg/flaskproject.git'
            }
        }

        stage('Build & Zip') {
            steps {
                echo 'Zipping it'
                sh 'tar -cvzf Crypto-Site.tar.gz flaskproject' // Zips the repository's content
            }
        }

        stage('Upload to S3') {
            steps {
                echo 'Uploading to S3'
                withAWS(region: 'eu-central-1', credentials: 'AWS') {
                    sh 'aws s3 cp Crypto-Site.tar.gz s3://jenkins-project1/' // Allows it to access the AWS account and copies the zip file to the S3 bucket
                    sh 'aws s3 ls s3://jenkins-project1' // Lists the contents of the S3 bucket for verification
                }
            }
        }

        stage('Deploy to EC2') {
            steps {
                echo 'Deploying to EC2'
                withCredentials([sshUserPrivateKey(credentialsId: 'SSH', keyFileVariable: 'KEY_FILE')]) {
                    sshagent(['SSH_ec2']) {
                        sh """
                            ssh -i \${KEY_FILE} -o StrictHostKeyChecking=no ec2-user@3.75.141.145 '
                                curl -o Crypto-Site.tar.gz https://jenkins-project1.s3.eu-central-1.amazonaws.com/Crypto-Site.tar.gz
                                tar -xzf Crypto-Site.tar.gz
                                rm -fr Crypto-Site.tar.gz
                                cd flaskproject
                                python app.py > /dev/null 2>&1 & disown
                            '
                        """
                    }
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                echo 'Verifying deployment'
                sshagent(['SSH_ec2']) {
                    sh 'ssh -i \${KEY_FILE} -o StrictHostKeyChecking=no ec2-user@3.75.141.145 "ps -ef | grep python"'
                }
            }
        }
    }
}
