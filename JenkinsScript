pipeline {
    agent any
    triggers {
        pollSCM('*/1 * * * *') //makes it build every minute
    }

    stages {
        stage('Cleanup') {
            steps {
                sh 'echo Cleaning up!'
                cleanWs() //cleans up the last run of the script because it cannot clone a git repository twice
            }
        }

        stage('Clone Repository') {
            steps {
                sh 'echo cloning repository'
                sh 'git clone https://github.com/EitanAizenberg/flaskproject.git'
            }
        }

        stage('Build & Zip') {
            steps {
                sh 'echo zipping it'
                sh 'tar -cvzf Crypto-Site.tar.gz flaskproject' //zips the repository's content
            }
        }

        stage('Upload to S3') {
            steps {
                sh 'echo uploading to S3'
                sh 'aws s3 cp Crypto-Site.tar.gz https://s3.console.aws.amazon.com/s3/buckets/jenkins-project1?region=eu-central-1&tab=objects' //allows it to access the AWS account and copies the zip file to the s3 bucket
            }
        }

        stage ('connecting to EC2 instance') {
            steps {
                sshagent(['MIIEogIBAAKCAQEAgxpZgCVtFeK3bfj3whFTObtKFLCWETnm3AZfIB/kouYfn651
qTrVSJoEdceiWM3dUPX0VG1m6j4/iFbkTVrXsAK7nicw50/S0ZlySvSarB8B/S95
0zD5CgySrIyAXzvZkvg6gc1wzDcKwrGdPVf0MEFc+mWAmtc0+G0vDSx1TC8uGhsB
+1avnPAGD+VvZ/nfqnX04m7bHNjIR3RMKL1LBVCYaATHOuDHI+F9cC0L70qEebRS
CkjavpO0EdrjsqBVkGpW5Nhx+TJE525skm4r/yJeLYkb17G8tDHkQcpxiEsRCC7N
+/tiROuGZKaGH2SGgg21cuHdhhaclCNhjYZ3OQIDAQABAoIBAHq3kmlaHwbqZeqh
rkBQ+UdD4a8GMCJFwavYpvgqAljc8WMF6YsT0AsaZ+xbhsJ7SJt87kyM71V6GPwk
4aTq0JQnqrj6VFNgq6SYbpxs488TY0g8RVuDLsnSRQUQqyT5n8prYlCYHep55y+h
E98U0jTNKhwUINJPeXzErtM090LsVL587tjadW9XPfrzEFmwvR2KkesCba9Pk8ir
CJgtFvqC7o1sTOacu3dacLWKZ/vn7shWO8nfJqEOVG8Ez/VimEFhJNc2S7kQsPm8
G8PJN3KQrVNNQiJxXYRmmImTq6KQJBg5RGls2T8lrNDxQHz98URhc4MOLyx6dlm7
3iCnIAECgYEA4GJusd5SuzwiMoG69hG0FjPHBPiF3j0y3y6omSDx3WvIODGjZqMW
PiNqebh9WlkKLUEYn4oSHV5EPchhKDwrvOGxb1zyRS5wafxydAQ5n0l8URw9gmMA
Zh6NwdSPrNcFoN42+Rcaa9GKEqh2uPsFpiSRrbZy4O6STiH4t37rezkCgYEAlZM+
PLey/Z9X/iuhSi6JKax3wy8NllqLnHPLpe4eZs/N9DgN7iZRNbGH3pbgc0KUpKgJ
6901NuepWVhQaP8zvDESea89EWPKyiT09lChh5kxDc5pCOiYSHFcDW1EKUBLFwhu
b/bbACyRPRb23ItGFTVBvZPfQVID2aXbsVhm3AECgYAKjxc+b4PdI7tIPSqbIcIj
uVQIO9mw15hpQDzW1+IJ1WSaoFtcHRiS2//Kso/TjJUaBBIwj8LCdwknDyLjTdGR
Fd3Pq8QK1WCc3DBWnUxI3qBnALk0RYxjQdTR5jrMm2G8bDiSCDBKGpYwwpSzp7xg
USA52HgXdaKU4qxdli9moQKBgC/r5ePEIyeY1rNLPTisIivk4tX5DExgpBwzCUsX
OExORbj6AJSNWDVwtIw/IJgs+7ypTcxwqez2Wc6TOef545Rm0HmGCHW62CzdnFIS
UT5FeW7n88Tz6F5FW2291Tm2LJirjd53Y4DxxnKhGeRdBs4iqvZXGw8tfKhNuE5g
eUwBAoGAH3/HzK6vE0LCyuHpEDOMpCfwtpig5MDHRj7PSJ2va+OBwBynEa7GS/dW
CXLrxpdwV6Xc4P3yyiG23PQmHHf0WBkay5wQ51nUNUMOJxsYy2bIxo7kqFQZvdQq
F9dAiuvhROysu0I4lX+zLCGAgppH8ftXmPs5djmPnx2gATtAjCo='])
            }

        stage ('clone s3 bucket into EC2 instance') {
            steps {
                sh 'echo cloning s3 bucket into an ec2 instance'
                sh 'aws s3 sync https://s3.console.aws.amazon.com/s3/buckets/jenkins-project1?region=eu-central-1&tab=objects https://eu-central-1.console.aws.amazon.com/ec2-instance-connect/ssh?connType=standard&instanceId=i-0d0f9dade003c4abf&osUser=ec2-user&region=eu-central-1&sshPort=22#/ /home/ec2-user/'
            }
        }
    }
}
